---
phase: 01-backend-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/tsconfig.json
  - backend/.env.example
  - backend/src/index.ts
  - backend/src/middleware/cors.ts
autonomous: true

must_haves:
  truths:
    - "Server starts without errors on PORT from environment"
    - "GET / returns health check response"
    - "CORS allows requests from FRONTEND_URL"
  artifacts:
    - path: "backend/package.json"
      provides: "Node.js project with dependencies"
      contains: "express"
    - path: "backend/tsconfig.json"
      provides: "TypeScript configuration"
      contains: "compilerOptions"
    - path: "backend/src/index.ts"
      provides: "Express server entry point"
      exports: ["app"]
    - path: "backend/src/middleware/cors.ts"
      provides: "CORS middleware configuration"
      exports: ["corsMiddleware"]
  key_links:
    - from: "backend/src/index.ts"
      to: "backend/src/middleware/cors.ts"
      via: "import and app.use()"
      pattern: "import.*cors"
---

<objective>
Set up Express server with TypeScript and CORS configuration

Purpose: Create the foundation for the backend API that will serve form explanations
Output: Running Express server with health check endpoint and CORS enabled
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Node.js project with TypeScript</name>
  <files>
    backend/package.json
    backend/tsconfig.json
    backend/.env.example
  </files>
  <action>
Create the backend directory and initialize the Node.js project with TypeScript support.

1. Create backend/ directory
2. Initialize package.json with the following content:

```json
{
  "name": "formbridge-backend",
  "version": "1.0.0",
  "description": "Backend API for FormBridge - explaining government forms in plain language",
  "main": "dist/index.js",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "@google/generative-ai": "^0.21.0"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/cors": "^2.8.17",
    "@types/node": "^20.10.0",
    "typescript": "^5.3.0",
    "tsx": "^4.7.0"
  }
}
```

3. Create tsconfig.json:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

4. Create .env.example:

```
PORT=5000
GEMINI_API_KEY=your_gemini_api_key_here
FRONTEND_URL=http://localhost:3000
```

5. Run npm install in the backend directory
  </action>
  <verify>
cd backend && npm install && ls node_modules/express node_modules/typescript
  </verify>
  <done>
package.json exists with all dependencies, tsconfig.json configured, npm install completes successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Express server with CORS and health check</name>
  <files>
    backend/src/index.ts
    backend/src/middleware/cors.ts
  </files>
  <action>
Create the Express server entry point and CORS middleware.

1. Create backend/src/middleware/cors.ts:

```typescript
import cors from 'cors';

const allowedOrigins = [
  process.env.FRONTEND_URL || 'http://localhost:3000',
];

export const corsMiddleware = cors({
  origin: (origin, callback) => {
    // Allow requests with no origin (like mobile apps or curl requests)
    if (!origin) return callback(null, true);

    if (allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
});
```

2. Create backend/src/index.ts:

```typescript
import express, { Request, Response, NextFunction } from 'express';
import dotenv from 'dotenv';
import { corsMiddleware } from './middleware/cors';

// Load environment variables
dotenv.config();

const app = express();
const PORT = process.env.PORT || 5000;

// Middleware
app.use(corsMiddleware);
app.use(express.json());

// Health check endpoint
app.get('/', (req: Request, res: Response) => {
  res.json({
    status: 'ok',
    message: 'FormBridge API is running',
    timestamp: new Date().toISOString(),
  });
});

// Error handling middleware
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
  console.error('Error:', err.message);
  res.status(500).json({
    error: 'Internal server error',
    message: process.env.NODE_ENV === 'development' ? err.message : undefined,
  });
});

// Start server
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});

export { app };
```

3. Create a .env file (copy from .env.example) - user will add their own GEMINI_API_KEY
  </action>
  <verify>
cd backend && cp .env.example .env && npm run dev &
sleep 3
curl http://localhost:5000
pkill -f "tsx watch"
  </verify>
  <done>
Server starts without errors, GET / returns JSON with status "ok", CORS middleware is applied
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npm run dev` starts server without errors
2. `curl http://localhost:5000` returns `{"status":"ok","message":"FormBridge API is running",...}`
3. Server logs show "Server running on http://localhost:5000"
</verification>

<success_criteria>
- Express server starts on configurable PORT
- Health check endpoint returns JSON response
- CORS configured to allow frontend origin
- TypeScript compiles without errors
- All dependencies installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-api/01-01-SUMMARY.md`
</output>
