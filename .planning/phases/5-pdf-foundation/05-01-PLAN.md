---
phase: 5-pdf-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/types/pdf.ts
  - backend/src/data/categories.ts
  - backend/src/data/forms-metadata.ts
  - backend/src/routes/categories.ts
  - backend/src/routes/pdf.ts
  - backend/src/utils/pdfValidation.ts
  - backend/src/index.ts
  - backend/public/pdfs/.gitkeep
  - frontend/src/types/pdf.ts
  - frontend/src/store/pdfStore.ts
  - frontend/src/components/pdf/PDFViewer.tsx
  - frontend/src/lib/pdfApi.ts
  - frontend/next.config.ts
  - frontend/package.json
  - backend/package.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "PDF types are defined for Category, PDFFormInfo, and PDFField"
    - "pdfStore manages PDF document state separately from formStore"
    - "PDFViewer component renders a PDF with zoom and page navigation"
    - "Backend serves PDF files from /api/pdf/:formId"
    - "XFA forms are detected and rejected with user-friendly message"
  artifacts:
    - path: "backend/src/types/pdf.ts"
      provides: "Category, PDFFormInfo, PDFField TypeScript interfaces"
      exports: ["Category", "PDFFormInfo", "PDFField", "PDFAnalysisResult"]
    - path: "frontend/src/store/pdfStore.ts"
      provides: "Zustand store for PDF state"
      exports: ["usePdfStore"]
    - path: "frontend/src/components/pdf/PDFViewer.tsx"
      provides: "PDF viewing component with react-pdf"
      exports: ["PDFViewer"]
    - path: "backend/src/routes/pdf.ts"
      provides: "PDF serving and XFA detection"
      exports: ["router"]
  key_links:
    - from: "frontend/src/components/pdf/PDFViewer.tsx"
      to: "pdfStore"
      via: "Zustand hook for currentPage, scale state"
      pattern: "usePdfStore"
    - from: "backend/src/routes/pdf.ts"
      to: "backend/public/pdfs/"
      via: "Express static file serving"
      pattern: "sendFile"
---

<objective>
Establish PDF infrastructure: TypeScript types, Zustand store for PDF state, react-pdf viewer component, and backend routes for serving PDFs with XFA detection.

Purpose: Create the foundation for all PDF-related features in v2.0. Types and store are required before any UI work. The viewer is the core visual component.

Output:
- Backend: PDF types, category/form metadata, PDF serving route with XFA detection
- Frontend: PDF types, pdfStore, PDFViewer component with zoom and page navigation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/API-CONTRACT-v2.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md

# Existing code to extend
@frontend/src/types/index.ts
@frontend/src/store/formStore.ts
@frontend/src/lib/api.ts
@frontend/next.config.ts
@backend/src/types/form.ts
@backend/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend PDF types, metadata, and routes</name>
  <files>
    backend/src/types/pdf.ts
    backend/src/data/categories.ts
    backend/src/data/forms-metadata.ts
    backend/src/routes/categories.ts
    backend/src/routes/pdf.ts
    backend/src/utils/pdfValidation.ts
    backend/src/index.ts
    backend/public/pdfs/.gitkeep
    backend/package.json
  </files>
  <action>
1. Create `backend/src/types/pdf.ts` with interfaces from API-CONTRACT-v2.md:
   - Category: { id, name, description, icon, formCount }
   - PDFFormInfo: { id, name, description, pdfUrl, pageCount, hasEligibilityCheck, signatureRequired }
   - PDFField: { id, name, type, label, page, bbox, required, options? }
   - PDFAnalysisResult: { pdfId, fields, textContent, isXFA, hasAcroForm }

2. Create `backend/src/data/categories.ts` with 5 categories:
   - social-assistance: "Ontario Works, ODSP, and other support programs"
   - education: "OSAP, grants, and student aid"
   - healthcare: "OHIP, drug benefits, and health coverage"
   - housing: "Rent assistance and housing support"
   - legal: "NDAs, consent forms, and legal documents"
   Use icon names: hand-helping, graduation-cap, heart-pulse, home, file-signature

3. Create `backend/src/data/forms-metadata.ts`:
   - Export a forms array with placeholder entries (1-2 per category)
   - For now, use placeholder PDF filenames like "ontario-works-sample.pdf"
   - Include realistic metadata (pageCount, hasEligibilityCheck, signatureRequired)

4. Create `backend/src/utils/pdfValidation.ts`:
   - isXFAForm(buffer: Buffer): boolean - check for XFA markers in PDF
   - XFA detection: Look for "/XFA" or "xmlns:xfa" in PDF content
   - Export clear error message: "This form uses XFA format which is not supported in web browsers. Please use the official PDF reader."

5. Create `backend/src/routes/categories.ts`:
   - GET /api/categories - return all categories with form counts
   - GET /api/categories/:categoryId/forms - return forms for that category

6. Create `backend/src/routes/pdf.ts`:
   - GET /api/pdf/:formId - serve PDF from backend/public/pdfs/
   - Check if form exists in metadata, return 404 if not
   - Set Content-Type: application/pdf, Content-Disposition: inline

7. Create `backend/public/pdfs/.gitkeep` directory for PDF storage

8. Update `backend/src/index.ts`:
   - Import and mount categories router at /api/categories
   - Import and mount pdf router at /api/pdf
   - Add express.static for public/pdfs directory

9. Install pdf-lib in backend for future PDF operations:
   ```bash
   cd backend && npm install pdf-lib
   ```
  </action>
  <verify>
    - `npm run build` in backend succeeds
    - `curl http://localhost:5001/api/categories` returns 5 categories
    - `curl http://localhost:5001/api/categories/social-assistance/forms` returns forms array
    - Types compile without errors
  </verify>
  <done>
    Backend has Category/PDFFormInfo/PDFField types, category metadata, categories routes returning data, and PDF serving route ready for files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend PDF types, pdfStore, and react-pdf viewer</name>
  <files>
    frontend/src/types/pdf.ts
    frontend/src/store/pdfStore.ts
    frontend/src/components/pdf/PDFViewer.tsx
    frontend/src/lib/pdfApi.ts
    frontend/next.config.ts
    frontend/package.json
  </files>
  <action>
1. Install react-pdf in frontend:
   ```bash
   cd frontend && npm install react-pdf
   ```

2. Update `frontend/next.config.ts` for react-pdf compatibility:
   ```typescript
   const nextConfig: NextConfig = {
     reactCompiler: true,
     webpack: (config) => {
       config.resolve.alias.canvas = false;
       config.resolve.alias.encoding = false;
       return config;
     },
   };
   ```

3. Create `frontend/src/types/pdf.ts` mirroring backend types:
   - Category, PDFFormInfo, PDFField, PDFAnalysisResult
   - Add PDFState interface for store

4. Create `frontend/src/store/pdfStore.ts` with Zustand:
   ```typescript
   interface PDFState {
     // Current PDF
     currentPdf: { id: string; url: string; name: string } | null;
     setCurrentPdf: (pdf: { id: string; url: string; name: string } | null) => void;

     // Viewer state
     currentPage: number;
     setCurrentPage: (page: number) => void;
     numPages: number;
     setNumPages: (num: number) => void;
     scale: number;
     setScale: (scale: number) => void;

     // Field values (for future use)
     fieldValues: Record<string, string | boolean>;
     setFieldValue: (fieldId: string, value: string | boolean) => void;

     // Active field (for AI integration)
     activeFieldId: string | null;
     setActiveFieldId: (id: string | null) => void;

     // Reset
     reset: () => void;
   }
   ```
   Use persist middleware with key 'formbridge-pdf-storage'

5. Create `frontend/src/lib/pdfApi.ts`:
   - getCategories(): Promise<Category[]>
   - getCategoryForms(categoryId: string): Promise<PDFFormInfo[]>
   - getPDFUrl(formId: string): string - returns full URL to /api/pdf/:formId

6. Create `frontend/src/components/pdf/PDFViewer.tsx`:
   - Use dynamic import with ssr: false for react-pdf Document/Page
   - Props: { pdfUrl: string }
   - Features:
     - Page navigation (prev/next buttons, page indicator "Page X of Y")
     - Zoom controls (zoom in, zoom out, reset to 100%)
     - Scale options: 0.5, 0.75, 1.0, 1.25, 1.5, 2.0
   - Loading state with spinner
   - Error state with user-friendly message
   - Use pdfStore for currentPage, numPages, scale state
   - Set PDF.js worker source: `pdfjs.GlobalWorkerOptions.workerSrc`
   - Use unpkg CDN for worker: `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`
  </action>
  <verify>
    - `npm run build` in frontend succeeds
    - No TypeScript errors in types or store
    - PDFViewer component renders without SSR errors
    - Console shows no react-pdf worker errors
  </verify>
  <done>
    Frontend has PDF types matching backend, pdfStore with viewer state, pdfApi functions, and PDFViewer component with zoom and page navigation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sample PDF and integration test</name>
  <files>
    backend/public/pdfs/sample-form.pdf
    frontend/src/app/test-pdf/page.tsx
  </files>
  <action>
1. Create a simple test PDF for development:
   - Use pdf-lib to programmatically create a 3-page sample form
   - Create a script `backend/scripts/createSamplePdf.ts`:
     ```typescript
     import { PDFDocument, StandardFonts } from 'pdf-lib';
     import fs from 'fs';

     async function createSamplePdf() {
       const pdfDoc = await PDFDocument.create();
       const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

       // Page 1
       const page1 = pdfDoc.addPage([612, 792]); // Letter size
       page1.drawText('Sample Government Form', { x: 50, y: 700, size: 24, font });
       page1.drawText('Page 1 - Personal Information', { x: 50, y: 650, size: 14, font });

       // Page 2
       const page2 = pdfDoc.addPage([612, 792]);
       page2.drawText('Page 2 - Employment Details', { x: 50, y: 700, size: 14, font });

       // Page 3
       const page3 = pdfDoc.addPage([612, 792]);
       page3.drawText('Page 3 - Signature', { x: 50, y: 700, size: 14, font });

       const pdfBytes = await pdfDoc.save();
       fs.writeFileSync('./public/pdfs/sample-form.pdf', pdfBytes);
       console.log('Created sample-form.pdf');
     }

     createSamplePdf();
     ```
   - Run with: `npx tsx scripts/createSamplePdf.ts`

2. Update `backend/src/data/forms-metadata.ts`:
   - Add entry for "sample-form" in social-assistance category
   - { id: "sample-form", name: "Sample Government Form", pdfUrl: "/pdfs/sample-form.pdf", pageCount: 3, ... }

3. Create `frontend/src/app/test-pdf/page.tsx` for testing:
   ```typescript
   'use client';

   import { PDFViewer } from '@/components/pdf/PDFViewer';
   import { getPDFUrl } from '@/lib/pdfApi';

   export default function TestPdfPage() {
     const pdfUrl = getPDFUrl('sample-form');

     return (
       <div className="container mx-auto p-4">
         <h1 className="text-2xl font-bold mb-4">PDF Viewer Test</h1>
         <div className="border rounded-lg overflow-hidden">
           <PDFViewer pdfUrl={pdfUrl} />
         </div>
       </div>
     );
   }
   ```

4. Test the full flow:
   - Start backend: `cd backend && npm run dev`
   - Start frontend: `cd frontend && npm run dev`
   - Visit http://localhost:3000/test-pdf
   - Verify PDF displays, zoom works, page navigation works
  </action>
  <verify>
    - Sample PDF exists at backend/public/pdfs/sample-form.pdf
    - curl http://localhost:5001/api/pdf/sample-form returns PDF binary
    - http://localhost:3000/test-pdf shows the PDF with controls
    - Page navigation shows "Page 1 of 3" and works
    - Zoom controls change the PDF size
  </verify>
  <done>
    Sample PDF created, forms metadata updated, test page works, PDF viewer displays with zoom and navigation controls.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Backend builds and runs without errors
2. Frontend builds and runs without errors
3. GET /api/categories returns 5 categories
4. GET /api/categories/social-assistance/forms returns forms array
5. GET /api/pdf/sample-form returns PDF binary
6. /test-pdf page displays PDF with working controls
7. No console errors related to react-pdf or SSR
</verification>

<success_criteria>
- PDF types defined in both backend and frontend
- pdfStore manages viewer state (page, zoom)
- PDFViewer component renders PDFs with zoom and page navigation
- Backend serves PDFs from /api/pdf/:formId
- XFA detection utility ready for use
- Sample PDF available for testing
</success_criteria>

<output>
After completion, create `.planning/phases/5-pdf-foundation/05-01-SUMMARY.md`
</output>
